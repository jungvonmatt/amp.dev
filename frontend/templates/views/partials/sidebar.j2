<amp-sidebar id="sidebar-left"
  class="ap--ampsidebar"
  layout="nodisplay"
  side="left">
  <nav toolbar="(min-width: 768px)"
    toolbar-target="ap--sidebar-content">

    <ul>
      <section class="ap-o-sidebar-section">
        {% do doc.styles.addCssFile('css/components/organisms/sidebar.css') %}

        <div class="ap-o-sidebar">
          {% include '/views/partials/format-toggle.j2' %}

          <div class="nav">
            {% macro nav_tree(root, iteration=1) -%}
              <amp-accordion id="{{ root.title|slug }}" class="nav-list level-{{ iteration }}">
                {% set collections = root.collections() %}
                {% set documents = root.list_docs(locale=doc.locale)|list %}
                {% set items = (collections + documents)|sort(attribute='order') %}
                {% for item in items %}

                  {# Check if the item is a) collection ... #}
                  {% if '<Collection' in item|pprint %}
                    {% set collection = item %}
                    {% set currentCollectionPaths = doc.collection.collection_path.split('/') %}
                    {% set allCollectionPaths = collection.collection_path.split('/') %}
                    {% set activeCollection = true if currentCollectionPaths[-1] == allCollectionPaths[-1] or currentCollectionPaths[-2] == allCollectionPaths[-1] else None %}

                    {% set formats = collection.formats or [] %}
                    <section class="nav-item nav-item-level-{{ iteration }} {% if activeCollection %}active {% endif %} {% for format in formats %}ap--{{ format }} {% endfor %} {% if loop.previtem and item.tutorial and not loop.previtem.tutorial %} nav-item-tutorial-divider {% endif %}">
                      <header class="nav-trigger">
                        <div class="nav-item-link nav-item-link-level-{{ iteration }}">

                          {# Get translated collection title #}
                          {% set collection_title = collection.tagged_fields.get('$title@' + doc.locale.language, collection.title) %}
                          {% if collection.tutorial %}
                            {% set tutorial_title = collection_title.split(' ') %}
                            {% set tutorial_first_part = ' '.join(tutorial_title[0:-1]) %}
                            {% set tutorial_last_word = tutorial_title[-1] %}

                            {% do doc.icons.useIcon('icons/tutorial.svg') %}
                            <span>{{ tutorial_first_part }}</span>
                            <span class="nav-link-lastword">{{ tutorial_last_word }}<svg class="ap-a-ico nav-type-icon"><use xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="#tutorial"></use></svg></span>

                          {% else %}
                            <span>{{ collection_title }}</span>
                          {% endif %}
                        </div>

                        <div class="nav-icon nav-icon-level-{{ iteration }}">
                          {% if iteration==1 %}
                            {% do doc.icons.useIcon('icons/angle-down-solid.svg') %}
                            <svg class="ap-a-ico"><use xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="#angle-down-solid"></use></svg>
                          {% else %}
                            {% do doc.icons.useIcon('icons/angle-down-light.svg') %}
                            <svg class="ap-a-ico light"><use xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="#angle-down-light"></use></svg>
                          {% endif %}
                        </div>
                      </header>
                      {{ nav_tree(item, iteration=iteration+1) }}
                    </section>

                    {# Check if the item is b) document #}
                    {% elif '<Document' in item|pprint %}
                    {% set document = item %}
                    {% set formats = document.formats or document.collection.formats or [] %}
                    {% set activeDocument = true if document.url == doc.url %}
                    <section {% if activeDocument %}autoscroll {% endif %} class="nav-item nav-item-level-{{ iteration }} {% if activeDocument %}active {% endif %}{% for format in formats %}ap--{{ format }}{% endfor %}">
                      <header class="nav-trigger">
                        {% if document.collection.tutorial %}
                          {% do doc.styles.addCssFile('/css/components/molecules/tutorial-progress.css') %}
                          <div class="ap-m-tutorial-progress {% if doc.order > document.order and doc.collection == document.collection %}ap-m-tutorial-progress-finished{% endif %}"></div>
                        {% endif %}
                        <a class="nav-item-link nav-item-link-level-{{ iteration }}" href="{{ document.url.path }}">
                          {{ document.title }}
                        </a>
                      </header>
                      <span></span>
                    </section>
                  {% endif %}

                {% endfor %}
              </amp-accordion>
            {%- endmacro %}

            {{ nav_tree(root=g.collection('/content/amp-dev/documentation/guides-and-tutorials')) }}
          </div>
        </div>
      </section>
    </ul>
  </nav>
</amp-sidebar>
